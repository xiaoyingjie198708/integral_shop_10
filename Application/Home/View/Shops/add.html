<link rel="stylesheet" href="__PUBLIC__/css/select2.css" />
<link rel="stylesheet" href="__PUBLIC__/css/uniform.css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery.uniform.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/select2.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/upload.jquery.js"></script>
<script charset="utf-8" src="__PUBLIC__/js/jquery.sortable.js"></script>
<style>
    .step_box{position:absolute;top:0;margin-top:5px;}
    .step_child{width: 20px; height:20px; border:4px solid #e6e6e6;border-radius:50%;background-color:#fdfdfd;position:absolute;cursor:pointer;}
    .step_box .active{border:4px solid #5eb95e;}
    .step_name{font-size:16px;position:absolute; white-space:nowrap;cursor:pointer;}
    
    .contact_box{ width:80%; margin-top:10px;overflow:hidden;border:1px solid #cdcdcd;}
    .contact_box .control-label{width:150px;}
    .contact_box .control-group{overflow:hidden;}
    .contact_box .controls{margin-left:150px;}
    .contact_box .form-actions{padding-left:160px;}
    .contact_box .contact_info{padding:10px 20px;float:left;}
    .contact_box .del{padding:10px 0 10px 30px;float:left;}
    .contact_box .update{padding:10px;float:left;}
    #contact_list .control-group:hover,#contact_list div.active{background-color:#eaeaea;}
    
    .img_box{margin:15px 0; overflow:hidden;}
    .img_box ul{list-style:none; margin:0;}
    .img_box ul li{float:left; width:140px; height:140px;cursor:pointer;margin-right:15px;margin-bottom:10px;}
    .img_box ul li:hover{border-color:#08c; box-shadow:0 1px 4px rgba(0,105, 214,0.25);}
    .img_box ul li.active{border-color:red; box-shadow:0 1px 4px rgba(0,105, 214,0.25);}
</style>
<div class="container-fluid">
    <div class="widget-box">
        <div class="widget-title add_box">
            <span class="icon">
                <i class="icon-plus"></i>									
            </span>
            <h5>添加商家</h5>
            <a class="btn btn-success btn-mini" href="{:back_list_url()}"><i class="icon-share-alt icon-white"></i> 返回列表</a>
        </div>
        <div class="widget-content nopadding">
            <form class="form-horizontal" method="post" ajax="true" action="{:U('Shops/add')}" id="add_form" autocomplete="off">
                <div class="control-group">
                    <label class="control-label"></label>
                    <div class="controls" style="position:relative;height:50px;">
                        <div class="progress progress-success" style="width:80%; height:20px;margin-bottom:0;">
                            <div class="bar"></div>
                        </div>
                    </div>
                </div>
            
                <div id="form-wizard-1" class="step" data-step="1">
                <div class="control-group">
                    <label class="control-label">商家名称：</label>
                    <div class="controls">
                        <input type="text" name="shops_name" placeholder="请输入商家名称" empty="请输入商家名称" id="shops_name" />
                        <div class="help-block">展示在后台的名称，如：国家大剧院-储值卡</div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">商家别名：</label>
                    <div class="controls">
                        <input type="text" name="alias_name" placeholder="请输入商家别名" empty="请输入商家别名" id="alias_name" />
                        <div class="help-block">展示在前台的名称，如：国家大剧院</div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">商家地址：</label>
                    <div class="controls">
                        <input type="text" name="shop_address" id="shop_address" placeholder="请输入商家地址" empty="请输入商家地址"/>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">商家电话：</label>
                    <div class="controls">
                        <!--<input type="text" name="shop_tel" id="shop_tel" placeholder="请输入商家电话" empty="请输入商家电话" regex="/^(8610|010|02\d{1}|0[3-9]\d{2})-\d{7,9}(-\d+)?$/" regexMsg="格式有误，请重新输入"/>-->
                        <input type="text" name="shop_tel" id="shop_tel" placeholder="请输入商家电话" empty="请输入商家电话"/>
                        <div class="help-block">电话格式:010-00000000</div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">营业时间：</label>
                    <div class="controls">
                        <!--<input type="text" name="office_hours" id="office_hours" placeholder="请输入营业时间" empty="请输入营业时间" regex="/^(([1-9]{1})|([0-1][0-9])|([1-2][0-3])):([0-5][0-9])-(([1-9]{1})|([0-1][0-9])|([1-2][0-3])):([0-5][0-9])$/" regexMsg="格式有误，请重新输入"/>-->
                        <input type="text" name="office_hours" id="office_hours" placeholder="请输入营业时间" empty="请输入营业时间"/>
                        <div class="help-block">营业时间格式：09:00-20:00,多个时间段分号分开</div>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">商家简介：</label>
                    <div class="controls">
                        <textarea id="shops_desc" name="shops_desc" placeholder="请输入商家简介"></textarea>
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label">商家LOGO：</label>
                    <div class="controls">
                        <button class="btn btn-success" type="button" id="upload_img"><i class="icon-picture icon-white"></i> 选择图片</button>
                        <div class="img_box" id="img_box">
                            <ul class="img_ul"></ul>
                        </div>
                        <input type="hidden" name="shops_logo" id="shops_logo"/>
                    </div>
                </div>
                </div>
                <div id="form-wizard-2" class="step hide" data-step="2">
                   <div class="control-group">
                        <label class="control-label">添加联系人：</label>
                        <div class="controls">
                            <button class="btn btn-success" type="button" id="add_contact_btn"><i class="icon-plus icon-white"></i> 添加联系人</button>
                            <div class="contact_box hide" id="contact_list"></div>
                            <div class="contact_box hide" id="add_contact_box">
                                <div class="control-group">
                                    <label class="control-label">联系人名称：</label>
                                    <div class="controls">
                                        <input id="contact_name" type="text" placeholder="请输入联系人姓名" />
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">手机号码：</label>
                                    <div class="controls">
                                        <input id="contact_phone" type="text" placeholder="请输入手机号码" />
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">邮箱：</label>
                                    <div class="controls">
                                        <input id="contact_email" type="text" placeholder="请输入邮箱" />
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <input id="contact_submit" class="btn btn-success" type="button" value="保存联系人" />
                                </div>
                            </div>
                        </div>
                    </div>
               </div>
                <div id="form-wizard-3" class="step hide" data-step="3">
                    <div class="control-group">
                        <label class="control-label"></label>
                        <div class="controls" style="width:80%;">
                            <div class="alert alert-success" style="width:80%;">
                                
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <a class="btn btn-success" id="add_sku_btn" data-url="{:U('Shops/add')}" href="{:U('Shops/add')}"><i class="icon-plus icon-white"></i> 继续添加</a>
                        <button id="back" type="button" onclick="location.href = '{:back_list_url()}'" class="btn btn-success"><i class="icon-share-alt icon-white"></i> 返回列表</button>
                    </div>    
                </div>
                <div class="form-actions">
                    <input id="prev" class="btn btn-primary" onclick="setStep(1)" disabled type="button" value="上一步" />
                    <input id="next" class="btn btn-primary" onclick="setStep(2)" type="button" value="下一步" />
                    <input id="submit" class="btn btn-primary hide" type="submit" value=" 保 存 " />
                </div>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript" src="__PUBLIC__/js/form.jquery.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/step.jquery.js"></script>
<script type="text/javascript">
    /*-----------------------------------------------------基础---------------------------------------------------*/
     var _ids,_p_ids,_id; //定义全局变量
    var _step = 1; //定义步骤变量
    var _step_count = Number('{$shops_label|count}'); //定义总共步骤
    var _step_names = $.parseJSON('{$shops_label|json_encode}');
    $('.progress').step({option:_step_count,name:_step_names}); //初始化步骤线
    $('input[type=checkbox],input[type=radio]').uniform(); //美化checkbox，radio按钮
    $('.progress').step(_step); //初始化步骤步数
    $('.step_child,.step_name').live('click',step_click);
    function step_click() {
        var _class = '';
        if ($(this).hasClass('step_child')) _class = '.step_child';
        if ($(this).hasClass('step_name')) _class = '.step_name';
        if(($(_class).index($(this))+1) > _step_count) return false;
        _step = $(_class).index($(this))+1;
        $('.progress').step(_step);
        setStep();
    }
    $('#goon').click(function() {
        _step = 1;
        $('.progress').step(_step);
        setStep();
        $('.step_child,.step_name').live('click',step_click);
        $.uniform.update();
    });
    //设置步骤
    function setStep(_ac) {
        if (_ac) _ac == 1 ? _step-- : _step++;
        _step == _step_count ? $('#submit').removeClass('hide') : $('#submit').addClass('hide');
        _step == 1 ? $('#prev').attr('disabled',true) : $('#prev').attr('disabled',false);
        _step == _step_count ? $('#next').addClass('hide') : $('#next').removeClass('hide');
        if(_step > _step_count) {
            $('#prev').addClass('hide');
            $('#next').addClass('hide');
            $('#submit').addClass('hide')
        }else {
            $('#prev').removeClass('hide');
        }
        $('.step').addClass('hide');
        $('#form-wizard-'+_step).removeClass('hide');
        $('.progress').step(_step);
        $('.step_child').each(function() {
            if($('.step_child').index($(this)) >= _step) $(this).removeClass('active');
        });
        $(document).scrollTop(0);
    }
    
    $("#upload_img").upload({
        multiple:false,
        success:function(data) {
            var _img_url = $("#img_box").find('.img_ul');
            var _hide = $("#shops_logo");
            //清空图片
            _img_url.children('li').remove();
            _hide.val('');
            if (data.savename) {
                var _path = data.savepath + data.savename;
                $('<li class="thumbnail" data-path="'+_path+'"></li>').html('<img src="'+createImageUrl(_path,'0_0')+'" />').appendTo(_img_url);
                _hide.val(_path);
            }
            _img_url.find('li').each(function() { image_center($(this));});
            if(_img_url.children().length) _img_url.sortable();
        }
    });
    /*-----------------------------------------------------联系人---------------------------------------------------*/
    //添加联系人
    $('#add_contact_btn').click(function() {
        $('#contact_submit').data('action','add').val('保存联系人');
        if ($('#contact_list').find('.active').length) {
            $('#add_contact_box').slideUp(600,function() {
                $('#contact_list').find('.active').removeClass('active');
                reset_contact();
                $('#add_contact_box').slideDown(600,function() {to_contact_box();});
            });
        }else {
            $('#add_contact_box').slideDown(600,function() {to_contact_box();});
        }        
    });
    //保存特性
    $('#contact_submit').click(function() {
        var _data = {};
        _data.contact_name = $('#contact_name').val();
        _data.contact_phone = $('#contact_phone').val();
        _data.contact_email = $('#contact_email').val();
        if (!_data.contact_name) {
            error('请输入联系人姓名',$('#contact_name'));
            $('#contact_name').focus();
            return false;
        }
        if (!/^1[3578]\d{9}$/.test(_data.contact_phone)) {
            error('请输入正确的手机号码',$('#contact_phone'));
            $('#contact_phone').focus();
            return false;
        }
        if ($(this).data('action') == 'update') {
            var _parent = $('#contact_list').find('.active');
            $(this).data('action','add').val('保存联系人');
            _parent.find('.contact_info').html($('#contact_name').val());
            _parent.data('data',_data);
            _parent.removeClass('active');
            $('#add_contact_box').slideUp(600,function() {reset_contact();});
        }else {
            $('#add_contact_box').slideUp(600,function() {
                var _contact_info = $('<div class="control-group"></div>').html('<div class="contact_info">'+$('#contact_name').val() +'</div><a class="del" href="javascript:;">删除</a><a class="update" href="javascript:;">修改</a>').appendTo($('#contact_list'));
                _contact_info.data('data',_data);
                $('#contact_list').slideDown(600);
                reset_contact();
            });
        }
    });
    //删除
    $('#contact_list').find('.del').live('click',function() {
        $(this).parent().fadeOut(300,function() {
            $(this).remove();
            if (!$('#contact_list .control-group').length) $('#contact_list').slideUp(600);
        });
        $('#add_contact_box').slideUp(600,function() {reset_contact();});
        $('#contact_list').slideDown(600);
    });
    //修改
    $('#contact_list').find('.update').live('click',function() {
        remove_error();
        var _this = $(this);
        $('#add_contact_box').slideUp(600,function() {
            $('#contact_list .control-group').removeClass('active');
            _this.parent().addClass('active');
            $('#contact_submit').val('更新联系人').data('action','update');
            var _data = _this.parent().data('data');
            $('#contact_name').val(_data.contact_name);
            $('#contact_phone').val(_data.contact_phone);
            $('#contact_email').val(_data.contact_email);
            $('#add_contact_box').slideDown(600,function() {to_contact_box();});
        });        
    });
    //定位到编辑特性盒子位置
    function to_contact_box() {
    }
    //重置添加特性数据
    function reset_contact() {
        remove_error();
        $('#contact_name').val('');
        $('#contact_phone').val('');
        $('#contact_email').val('');
    }
     /*-----------------------------------------------------提交表单---------------------------------------------------*/
    $('#add_form').form({
        start:function() {
            $('.error').removeClass('error');
            remove_error();
            set_contact();
        },
        error:function(data,_this) {
            if (_this) {
                error(data,_this);
                $('.error').removeClass('error');
                _this.parents('.control-group').addClass('error');
                _step = _this.data('step') ? _this.data('step') : _this.parents('.step').data('step');
                $('.progress').step(_step);
                setStep();
            }else alert(data);
        },
        ajaxcallback:function(data) {
            if (data.status) {
                $("#add_form")[0].reset();
                $('.img_box ul li').remove();
                $('#contact_list').html('').hide();
                $('#add_contact_box').hide();
                $('.step_child,.step_name').die('click');                
                $('.alert-success').html('<strong>添加成功！</strong><br />商家添加成功，商家名称：'+data.data);
                _step = 3;
                $('.progress').step(_step);
                setStep();
            }else {
                if (data.data) {
                    var _obj = $('#'+data.data);
                    $('.error').removeClass('error');
                    _obj.parents('.control-group').addClass('error');
                    _obj.focus();
                    error(data.info,_obj);
                    _step = _obj.parents('.step').data('step');
                    $('.progress').step(_step);
                    setStep();
                }else {
                    alert(data.info);
                }
            }
        }
    });
    
    //处理联系人数据
    function set_contact() {
        $('.other_data_param').remove();
        $('#contact_list .control-group').each(function() {
            $('<input type="hidden" class="other_data_param" name="shops_contacts[]" value="'+$.param($(this).data('data'))+'" />').appendTo($('#add_form'));
        });
    }
</script>